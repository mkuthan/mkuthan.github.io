---
layout: slide
title: "Domain Driven Design"
reveal:
  theme: sky
  controls: false
  progress: false
  history: true
  transition: default
---

<section>
    <section>
        <h1>{{ page.title }}</h1>

        <h3>from the trenches for practitioners</h3>

        <p>
            <small>Created by <a href="http://mkuthan.github.io">Marcin Kuthan</a></small>
        </p>

        <aside class="notes">
            <ul>
                <li>Domain Driven Design is a comprehensive methodology in software engineering.</li>
                <li>For DDD practitioners or techies after Eric and Vernon studies who want to practice.</li>
            </ul>
        </aside>
    </section>
    <section>
        <h1>About me</h1>

        <h3>Marcin Kuthan</h3>

        <img src="https://secure.gravatar.com/avatar/71e9ba5350f53c3416b7ed2617d04ab5" alt="Marcin Kuthan"
             style="border: 1px; border-radius: 20px">

        <p>Technical leader at Grupa Allegro</p>

        <p><i class="fa fa-github"></i>&nbsp;<a href="http://mkuthan.github.io">mkuthan.github.io</a></p>
    </section>
    <section>
        <h2>The Talk</h2>

        <svg width="640" height="480" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
            <!-- Created with SVG-edit - http://svg-edit.googlecode.com/ -->

            <g>
                <title>Layer 1</title>
                <ellipse transform="rotate(-34.2011, 194.958, 221.312)" ry="130.01426" rx="159.257901" id="svg_9" cy="221.311844" cx="194.957273" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#cccccc"/>
                <polyline id="svg_1" fill="none" stroke-width="3" stroke="#000000" points="11.689258354391939,256.23974609375 304.9715783835527,255.23973083496094 598.2539138450666,254.23973083496094 "/>
                <polyline id="svg_2" transform="rotate(90, 299.254, 240.059)" fill="none" stroke-width="3" stroke="#000000" points="93.19846177524596,241.0601043701172 299.2551190463164,240.0601043701172 505.31177631738683,239.0601043701172 "/>
                <text xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" id="svg_5" y="55.465136" x="455.348843" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">obvious</text>
                <text xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" id="svg_6" y="53.139554" x="166.976733" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">vague</text>
                <text transform="rotate(-90, 25.6977, 349.651)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" id="svg_7" y="357.790743" x="25.697649" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">important</text>
                <text transform="rotate(-90, 26.279, 154.884)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" id="svg_8" y="163.023283" x="26.279045" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">essential</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" id="svg_11" y="157.494742" x="497.369667" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">ubiquitous language</text>
                <text id="svg_12" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="512.305179" x="293.064104" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">factories</text>
                <text id="svg_15" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="559.476925" x="477.784334" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">repositories</text>
                <text id="svg_17" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="463.820367" x="457.035307" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">entities</text>
                <text id="svg_21" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="396.951654" x="284.730119" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">value objects</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="207.860751" x="22.49777" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000" id="svg_3">aggregates</text>
                <text id="svg_4" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="122.406196" x="-26.770124" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">bounded contexts</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="409.678926" x="-76.038028" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000" id="svg_10">application services</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="606.042556" x="-18.823697" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000" id="svg_13">domain services</text>
                <text id="svg_14" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="293.858373" x="389.298151" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">layered architecture</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="622.002179" x="293.338744" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000" id="svg_16">specifications</text>
                <text id="svg_18" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="291.497113" x="-144.377371" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">domain events</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="90.222017" x="274.869489" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000" id="svg_19">context map</text>
                <text id="svg_20" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="486.04256" x="-12.466549" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">shared kernel</text>
                <text transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="296.951659" x="47.926362" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000" id="svg_22">cohesion</text>
                <text id="svg_23" transform="matrix(0.629213, 0, 0, 0.55, 207.858, 64.1454)" xml:space="preserve" text-anchor="middle" font-family="Sans-serif" font-size="24" y="222.949286" x="384.530289" stroke-linecap="null" stroke-linejoin="null" stroke-dasharray="null" stroke-width="0" stroke="#000000" fill="#000000">core domain</text>
            </g>
        </svg>

        <aside class="notes">
            <ul>
                <li class="fragment">What I learnt about DDD by the hard way.</li>
                <li class="fragment">What I almost missed in blue book.</li>
                <li class="fragment">Do not expect quick DDD guide.</li>
            </ul>
        </aside>
    </section>
</section>

<section>
    <h2>Anemic domain model rot over time</h2>

    <aside class="notes">
        <ul>
            <li>More complex fragments of the application degrade regardless of effort put on quality.</li>
            <li>Verified on several green-field projects.</li>
        </ul>
    </aside>
</section>

<section>
    <h2>Rich domain model is expensive</h2>

    <aside class="notes">
        <ul>
            <li>High learning curve.</li>
            <li>Complex building blocks and patterns.</li>
        </ul>
    </aside>
</section>

<section>
    <h2>Anemic and rich domain model works together</h2>

    <aside class="notes">
        <ul>
            <li>There is no single valid architecture for whole system.</li>
            <li>Use anemic model for CRUD like bounded contexts, e.g: admin panels, mdm.</li>
            <li>Use rich domain model for core / complex bounded contexts.</li>
            <li>Do not mix anemic and rich domain in single bounded context.</li>
            <li>Make your architecture decision clear for everyone in the team.</li>
        </ul>
    </aside>
</section>

<section>
    <section>
        <h2>Bounded context should be highly cohesive</h2>

        <aside class="notes">
            <ul>
                <li>Should have all information needed by operations.</li>
                <li>Should not have information irrelevant to operations.</li>
            </ul>
        </aside>
    </section>

    <section>
        <h2>Low cohesive bounded context model</h2>

        <pre><code data-trim class="java">
package com.acme.ecommerce.shared

class Product {
  id
  externalId
  name
  description
  photos
  opinions
  categories
  packages
  prices
  discounts
  availability
  (...)
}
        </code></pre>

        <aside class="notes">
            <ul>
                <li>Hypothetical core entity for e-commerce platform.</li>
                <li>"Noun" based design.</li>
            </ul>
        </aside>
    </section>

    <section>
        <h2>Model behaviours not state</h2>

        <pre><code data-trim class="java">
package com.acme.ecommerce.inventory

class InventoryService {
  addInventoryEntry(productId, numberAvailable, ...) {}
  makeReservation(productId, numberRequested, ...) {}
}
        </code></pre>

        <pre><code data-trim class="java">
package com.acme.ecommerce.ordermanagement

class OrderService {
  addOrderLine(productId, productName, price, quantity, ...) {}
}
        </code></pre>

        <aside class="notes">
            <ul>
                <li>Forget about data structures, focus on behaviours.</li>
                <li>Product attributes are disjoint.</li>
                <li>For inventory product is "inventory item", for order management "product summary".</li>
                <li>Driven by business operations not UI views, UI is a composite of many bounded contexts.</li>
            </ul>
        </aside>
    </section>
</section>

<section>
    <section>
        <h2>Aggregate should be highly cohesive</h2>
    </section>

    <section>
        <h2>Low cohesive aggregate</h2>

        <pre><code data-trim class="java">
class Product {
  void updateDetails(...) // name, description, features
  void updatePrice(...) // amount, currency, validity period
  void makeReservation(...) // how many, how long
}
        </code></pre>
    </section>

    <section>
        <h2>Look for aggregate actors</h2>

        <ul>
            <li class="fragment">Content Manager: <code>updateDetails()</code></li>
            <li class="fragment">Marketing Director: <code>updatePrice()</code></li>
            <li class="fragment">Customer: <code>makeReservation()</code></li>
        </ul>

        <aside class="notes">
            <ul>
                <li>Single actor per aggregate.</li>
                <li>Content Manager: tiny concurrency, optimistic locking.</li>
                <li>Marketing Director: no concurrency.</li>
                <li>Customer: high concurrency, pessimistic locking.</li>
            </ul>
        </aside>
    </section>
</section>

<section>
    <section>
        <h2>Encapsulate domain</h2>

        <aside class="notes">
            <ul>
                <li>Do you like integration using database?</li>
                <li>Do not expose your domain data structures.</li>
                <li>Use DTO, Commands, Queries, etc.</li>
            </ul>
        </aside>
    </section>

    <section>
        <h2>Domain example</h2>

        <pre><code data-trim class="java">
package com.acme.ecommerce.ordermanagement.domain.orders

class Order {
  OrderId id
  List&lt;OrderLine&gt; lines

  Order(OrderId id, ...) {
    this.id = requireNotNull(id)
    (...)
  }
}

class OrderLine {
  ProductSummary product // id, name
  Quantity quantity
  Money price // amount, currency
}
        </code></pre>

        <aside class="notes">
            <ul>
                <li>Rich, complex model with strong invariants.</li>
                <li>Many small classes with well defined responsibilities (SRP).</li>
            </ul>
        </aside>
    </section>

    <section>
        <h2>API example</h2>

        <pre><code data-trim class="java">
package com.acme.ecommerce.ordermanagement.rest

class AddOrderLineCommand {
  String productId
  int quantity
  int amount // cents, grosze
  String currency
}

class OrderController {
  @Autowired OrderService orderService

  addOrderLine(AddOrderLineCommand command) {
    // convert command into OrderService API
    orderService.addOrderLine(productId, quantity, price)
  }
}
        </code></pre>

        <aside class="notes">
            <ul>
                <li>Simple data types, interoperable, easy to marshall.</li>
                <li>Focused on use cases or caller needs.</li>
                <li>Do not try automagic mappers (e.g Dozer).</li>
            </ul>
        </aside>
    </section>
</section>

<section>
    <h2>Organize packages around domain</h2>

    <pre><code data-trim>
com
└── acme
    └── ecommerce
        └── ordermanagement
            └── domain
                └── orders
                    ├── channels
                    │   ├── allegro
                    │   └── ceneo
                    ├── payments
                    │   ├── cod
                    │   └── payu
                    └── delivery
                        ├── inpost
                        └── dhl
    </code></pre>

    <aside class="notes">
        <ul>
            <li>Go to the domain expert / product owner and try to explain packages responsibilities.</li>
        </ul>
    </aside>
</section>

<section>
    <h2>Organize classes around domain</h2>

    <pre><code data-trim class="java">
package com.acme.ecommerce.ordermanagement.domain.orders

interface OrderRepository {} // repository
class OrderFactory {} // factory
class Order {} // aggregate root
class OrderLine {} // value object
class ProductSummary {} // value object
class TaxCalculator {} // domain service
interface TaxRatesProvider{} // domain service (external)
class OrderPaymentAcceptedEvent{} // domain event
    </code></pre>

    <aside class="notes">
        <ul>
            <li>One change request - single package needs to be modified.</li>
            <li>Consider Spring Framework with all exception classes in single package.</li>
        </ul>
    </aside>
</section>

<section>
    <h2>Organized infrastructure around frameworks</h2>

    <pre><code data-trim class="java">
package com.acme.ecommerce.ordermanagement.infrastructure.mongo

class MongoOrderRepository implements OrderRepository {}
// all Mongo repositories
    </code></pre>

    <pre><code data-trim class="java">
package com.acme.ecommerce.ordermanagement.infrastructure.rest

class RestTaxRatesProvider implements TaxRatesProvider {}
// all REST clients
    </code></pre>

    <aside class="notes">
        <ul>
            <li>Infrastructure provide cross cutting domain features.</li>
            <li>Integration tests configuration is framework specific and should be shared.</li>
        </ul>
    </aside>
</section>

<section>
    <section>
        <h2>Be pragmatic in testing</h2>
    </section>

    <section>
        <h2>Application service</h2>

        <pre><code data-trim class="java">
class OrderService {
  @Autowired orderRepository, taxCalculator, orderLineValidator, ...

  @Transactional @PreAuthorized
  void addOrderLine(orderId, productId, productName, quantity, ...) {
     order = orderRepository.load(orderId)

     orderLineValidator.validate(...)
     tax = taxCalculator.calculate(...)
     order.addOrderLine(...)

     orderRepository.save(order)
  }
}
        </code></pre>

        <p class="fragment"><i class="fa fa-check"></i> No unit tests, consider acceptance tests on service level</p>

        <aside class="notes">
            <ul>
                <li>Use case realization.</li>
                <li>Delegates to domain.</li>
                <li>Many dependencies.</li>
                <li>Place for transactional and security aspects.</li>
            </ul>
        </aside>
    </section>

    <section>
        <h2>Domain entity or service</h2>

        <pre><code data-trim class="java">
class Order {
  Order(orderId, customerId, ...) {}

  void addOrderLine(...) {
    if (isOrderLineForProductExist(...)) {
      orderLines.update(...)
      pendingEvents.add(new OrderLineUpdated(...))
    } else {
      orderLines.add(...)
      pendingEvents.add(new OrderLineAdded(...))
    }
  }

  List&lt;DomainEvent&gt; pendingEvents = []
}
        </code></pre>

        <p class="fragment"><i class="fa fa-check"></i> Only unit tests, sometimes with mocks, no Spring context</p>

        <aside class="notes">
            <ul>
                <li>Business logic.</li>
                <li>No dependencies (or only few).</li>
                <li>Pure Java/Groovy/Scala/... no magic.</li>
            </ul>
        </aside>
    </section>

    <section>
      <h2>Infrastructure</h2>

      <pre><code data-trim class="java">
class RestTaxesProvider implements TaxesProvider {
  @Autowired RestTemplate restTemplate
  @Autowired TaxRateAssembler taxRateAssembler

  List&lt;TaxRate&gt; fetchTaxRates() {
    // authentication
    List&lt;StrangeStructure&gt; results = restTemplate.getForObject(...)
    return taxRateAssembler.assembly(results)
  }
}
      </code></pre>

      <p class="fragment"><i class="fa fa-check"></i> Spring integration tests using production like environment</p>

      <aside class="notes">
        <ul>
            <li>Technical complexity realization.</li>
            <li>Anti corruption layer (data assembly, exceptions mapping).</li>
        </ul>
      </aside>
    </section>
</section>

<section>
    <section>
        <h2>Avoid shared kernel for integration</h2>

        <p class="fragment"><i class="fa fa-exchange"></i> Coupling is too high </p>
        <p class="fragment"><i class="fa fa-group"></i> Coordination effort is also high</p>
    </section>

    <section>
        <h2>Shared domain code</h2>

        <p>"Micro" or "Nano" shared kernel for general purpose classes (e.g: Money)</p>
    </section>

    <section>
        <h2>Shared infrastructure code</h2>

        <p>Opensource your kernel <i class="fa fa-github"></i></p>
    </section>
</section>

<section>
    <section>
        <h2>Consider domain events for bounded contexts integration</h2>

        <p><em>Disclaimer: I'm not fully convinced <i class="fa fa-meh-o"></i></em></p>
    </section>

    <section>
        <h2>Traditional way</h2>

        <pre><code data-trim class="java">
class OrderService {
  void placeOrder(...) {
    order = orderFactory.createOrder(...)
    orderRepository.save(order)

    emailNotificationService.notifyCustomer(...)
    indexerService.updateIndex(...)
    inventoryService.makeReservation(...)
    paymentService.sendPayment(...)
    (...)
  }
}
        </code></pre>
    </section>

    <section>
        <h2>It sucks</h2>

        <ul>
            <li class="fragment">Temporal coupling</li>
            <li class="fragment">Degraded availability</li>
            <li class="fragment">Not atomic operation</li>
            <li class="fragment">Broken domain model encapsulation</li>
            <li class="fragment">Business logic drift from domain to application service</li>
        </ul>
    </section>

    <section>
        <h2>Integration using domain events</h2>

        <pre><code data-trim class="java">
class Order implements AggragateRoot {
  void placeOrder(...) {
    (...)
    pendingEvents.add(new OrderPlacedEvent(...))
  }

  List&lt;DomainEvent&gt; pendingEvents = []
}
        </code></pre>

        <pre><code data-trim class="java">
class OrderService {
    void placeOrder(...) {
      order = orderFactory.createOrder(...)
      order.placeOrder(...)
      orderRepository.save(order)
    }
}
        </code></pre>

        <pre><code data-trim class="java">
@AfterReturning(pointcut = "execution(public * *.Repository+.save(..))")
void publishPendingEvents(AggregateRoot aggregateRoot) {
  for (DomainEvent event : aggregateRoot.getPendingEvents()) {
    eventPublisher.publish(event)
  }
}
        </code></pre>
    </section>

    <section>
        <h2>Seams to work</h2>
        <ul>
            <li class="fragment">No temporal coupling</li>
            <li class="fragment">Availability == messaging middleware availability</li>
            <li class="fragment">Almost atomic</li>
            <li class="fragment">Domain model stays encapsulated</li>
        </ul>
    </section>
</section>

<section>
    <h2>But ...</h2>
</section>

<section>
    <h2>Be fine with "eventual consistency"</h2>

    <p class="fragment">Your order cancellation request has been accepted ...</p>

    <aside class="notes">
        <ul>
            <li>Not a problem at all.</li>
        </ul>
    </aside>
</section>

<section>
    <h2>Configure redelivery policy</h2>

    <p class="fragment"><i class="fa fa-bar-chart-o"></i> Exponential back off</p>
    <p class="fragment"><i class="fa fa-clock-o"></i> TTL</p>
    <p class="fragment"><i class="fa fa-envelope"></i> Dead Letter Queue</p>
</section>

<section>
    <h2>Assume "at least one message delivery guarantee"</h2>

    <p class="fragment"><i class="fa fa-inbox"></i> Idempotent receiver</p>
    <p class="fragment"><i class="fa fa-copy"></i> Deduplication</p>
</section>

<section>
    <h2>Handle out of order domain events</h2>

    <p class="fragment"><i class="fa fa-gears"></i> Consistent hashing</p>
    <p class="fragment"><i class="fa fa-rotate-left"></i> Re-sequencing messages</p>
</section>

<section>
    <h2>Apply versioning to domain events</h2>
</section>

<section>
    <h2>Master message middleware management and monitoring tools</h2>
</section>

<section>
    <h2>Look further</h2>

    <p class="fragment">Command Query Responsibility Segregation (CQRS)</p>
    <p class="fragment">Event Sourcing (ES)</p>
</section>

<section>
    <h2>Summary</h2>

    <ul>
        <li class="fragment">DDD comprehensively develops your skills</li>
        <li class="fragment">DDD helps in building complex systems using micro-services / SOA architecture</li>
        <li class="fragment">DDD helps in building scalable distributed systems</li>
    </ul>

    <aside class="notes">
        <ul>
            <li>DDD is not about frameworks and programming languages - it is general purpose methodology.</li>
            <li>Bounded contexts ~ decoupled and autonomous Micro Service.</li>
            <li>Aggregate roots play nicely without ACID.</li>
            <li>Domain Events is a natural way to distribute your system.</li>
        </ul>
    </aside>
</section>

<section>
    <h2>Q &amp; A</h2>
</section>
