
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Kafka Streams DSL vs Processor API - Passionate Developer</title>
  <meta name="author" content="Marcin Kuthan">

  
  <meta name="description" content="Kafka Streams is a Java library
for building real-time, highly scalable, fault tolerant, distributed applications.
The library is fully integrated &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mkuthan.github.io/blog/2017/11/02/kafka-streams-dsl-vs-processor-api">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Passionate Developer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-50832428-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Passionate Developer</a></h1>
  
    <h2>Memory is unreliable like a software, so make my thoughts more eternal and my software more reliable</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mkuthan.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Kafka Streams DSL vs Processor API</h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-11-02T00:00:00+00:00" pubdate data-updated="true">Nov 2<span>nd</span>, 2017</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="https://docs.confluent.io/current/streams/index.html">Kafka Streams</a> is a Java library
for building real-time, highly scalable, fault tolerant, distributed applications.
The library is fully integrated with <a href="https://kafka.apache.org/documentation/">Kafka</a> and leverages
Kafka producer and consumer semantics (e.g: partitioning, rebalancing, data retention and compaction).
What is really unique, the only dependency to run Kafka Streams application is a running Kafka cluster.
Even local state stores are backed by Kafka topics to make the processing fault tolerant &ndash; brilliant!</p>

<p>Kafka Streams provides all necessary stream processing primitives like one-record-at-a-time processing,
event time processing, windowing support and local state management.
Application developer can choose from three different Kafka Streams APIs: DSL, Processor or KSQL.</p>

<ul>
<li><p><a href="https://docs.confluent.io/current/streams/developer-guide.html#kafka-streams-dsl">Kafka Streams DSL</a>
(Domain Specific Language) &ndash; recommended way for most users
because business logic can be expressed in a few lines of code.
All stateless and stateful transformations are defined using declarative,
functional programming style (filter, map, flatMap, reduce, aggregate operations).
Kafka Stream DSL encapsulates most of the stream processing complexity
but unfortunately it also hides many useful knobs and switches.</p></li>
<li><p><a href="https://docs.confluent.io/current/streams/developer-guide.html#processor-api">Kafka Processor API</a>
provides a low level, imperative way to define stream processing logic.
At first sight Processor API could look hostile but finally gives much more flexibility to developer.
With this blog post I would like to demonstrate that hand-crafted stream processors might be a magnitude more efficient
than a naive implementation using Kafka DSL.</p></li>
<li><p><a href="https://www.confluent.io/product/ksql/">KSQL</a>
is a promise that stream processing could be expressed by anyone using SQL as the language.
It offers an easy way to express stream processing transformations as an alternative to writing
an application in a programming language such as Java.
Moreover, processing transformation written in SQL like language can be highly optimized
by execution engine without any developer effort.
KSQL was released recently and it is still at very early development stage.</p></li>
</ul>


<p>In the first part of this blog post I&rsquo;ll define simple but still realistic business problem to solve.
Then you will learn how to implement this use case with Kafka Stream DSL
and how much the processing performance is affected by this naive solution.
At this moment you could stop reading and scale-up Kafka cluster ten times to fulfill business requirements
or you could continue reading and learn how to optimize the processing with low level Kafka Processor API.</p>

<h2>Business Use Case</h2>

<p>Let&rsquo;s imagine a web based e-commerce platform with fabulous recommendation and advertisement systems.
Every client during visit gets personalized recommendations and advertisements,
the conversion is extraordinarily high and platform earns additional profits from advertisers.
To build comprehensive recommendation models,
such system needs to know everything about clients traits and their behaviour.</p>

<p>To make it possible, e-commerce platform reports all clients activities as an unbounded stream
of page views and events.
Every time the client enters web page, a so-called page view is sent to Kafka cluster.
A page view contains web page attributes like request URI, referrer URI, user agent, active A/B experiments
and many more.
In addition to page view all important actions are reported as custom events, e.g: search, add to cart or checkout.
To get a complete view of the activity stream, collected events need to be enriched with data from page views.</p>

<h2>Data Model</h2>

<p>Because most of the processing logic is built within context of given client,
page views and events are evenly partitioned on Kafka topics by the client identifier.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">type</span> <span class="kt">ClientId</span> <span class="o">=</span> <span class="nc">String</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">ClientKey</span><span class="o">(</span><span class="n">clientId</span><span class="k">:</span> <span class="kt">ClientId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bob</span> <span class="k">=</span> <span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">jim</span> <span class="k">=</span> <span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;jim&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Page view and event structures are different so messages are published to separate Kafka topics
using ingestion time as the event time.
Our system should not rely on page view or event creation time due to high client clocks variance.
The topic key is always <code>ClientKey</code> and value is either <code>Pv</code> or <code>Ev</code> presented below.
For better examples readability page view and event payload is defined as simplified single value field.
Events are uniquely identified by <code>pvId</code> and <code>evId</code> pair, <code>pvId</code> could be a random identifier, <code>evId</code>
a sequence number.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">type</span> <span class="kt">PvId</span> <span class="o">=</span> <span class="nc">String</span>
</span><span class='line'><span class="k">type</span> <span class="kt">EvId</span> <span class="o">=</span> <span class="nc">String</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Pv</span><span class="o">(</span><span class="n">pvId</span><span class="k">:</span> <span class="kt">PvId</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Ev</span><span class="o">(</span><span class="n">evId</span><span class="k">:</span> <span class="kt">EvId</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">pvId</span><span class="k">:</span> <span class="kt">PvId</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enriched results <code>EvPv</code> is published to output Kafka topic using <code>ClientKey</code> as message key.
This topic is then consumed directly by advertisement and recommendation systems.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">EvPv</span><span class="o">(</span><span class="n">evId</span><span class="k">:</span> <span class="kt">EvId</span><span class="o">,</span> <span class="n">evValue</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">pvId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">PvId</span><span class="o">],</span> <span class="n">pvValue</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Example Scenario</h2>

<p>For client &ldquo;bob&rdquo; the following page views and events are collected by the system.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Bob enters main page</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Pv</span><span class="o">(</span><span class="s">&quot;pv0&quot;</span><span class="o">,</span> <span class="s">&quot;/&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A few impression events collected almost immediately</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Ev</span><span class="o">(</span><span class="s">&quot;ev0&quot;</span><span class="o">,</span> <span class="s">&quot;show header&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Ev</span><span class="o">(</span><span class="s">&quot;ev1&quot;</span><span class="o">,</span> <span class="s">&quot;show ads&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Ev</span><span class="o">(</span><span class="s">&quot;ev2&quot;</span><span class="o">,</span> <span class="s">&quot;show recommendation&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// There is also single duplicated event, welcome to distributed world</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Pv</span><span class="o">(</span><span class="s">&quot;ev1&quot;</span><span class="o">,</span> <span class="s">&quot;show ads&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A dozen seconds later Bob clicks on one of the offers presented on the main page</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Pv</span><span class="o">(</span><span class="s">&quot;ev3&quot;</span><span class="o">,</span> <span class="s">&quot;click recommendation&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Out of order event collected before page view on the offer page </span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Ev</span><span class="o">(</span><span class="s">&quot;ev0&quot;</span><span class="o">,</span> <span class="s">&quot;show header&quot;</span><span class="o">,</span> <span class="s">&quot;pv1&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Offer page view</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Pv</span><span class="o">(</span><span class="s">&quot;pv1&quot;</span><span class="o">,</span> <span class="s">&quot;/offer?id=1234&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// An impression event published almost immediately after page view</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Ev</span><span class="o">(</span><span class="s">&quot;ev1&quot;</span><span class="o">,</span> <span class="s">&quot;show ads&quot;</span><span class="o">,</span> <span class="s">&quot;pv1&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Late purchase event, Bob took short coffee break before the final decision</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">Ev</span><span class="o">(</span><span class="s">&quot;ev2&quot;</span><span class="o">,</span> <span class="s">&quot;add to cart&quot;</span><span class="o">,</span> <span class="s">&quot;pv1&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>For above clickstream the following enriched events output stream is expected.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Events from main page without duplicates</span>
</span><span class='line'>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev0&quot;</span><span class="o">,</span> <span class="s">&quot;show header&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">,</span> <span class="s">&quot;/&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev1&quot;</span><span class="o">,</span> <span class="s">&quot;show ads&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">,</span> <span class="s">&quot;/&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev2&quot;</span><span class="o">,</span> <span class="s">&quot;show recommendation&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">,</span> <span class="s">&quot;/&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev3&quot;</span><span class="o">,</span> <span class="s">&quot;click recommendation&quot;</span><span class="o">,</span> <span class="s">&quot;pv0&quot;</span><span class="o">,</span> <span class="s">&quot;/&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Events from offer page, somehow incomplete due to streaming semantics limitations</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// early event</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev0&quot;</span><span class="o">,</span> <span class="s">&quot;show header&quot;</span><span class="o">,</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev1&quot;</span><span class="o">,</span> <span class="s">&quot;show ads&quot;</span><span class="o">,</span> <span class="s">&quot;pv1&quot;</span><span class="o">,</span> <span class="s">&quot;/offer?id=1234&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// late event</span>
</span><span class='line'><span class="nc">ClientKey</span><span class="o">(</span><span class="s">&quot;bob&quot;</span><span class="o">),</span> <span class="nc">EvPv</span><span class="o">(</span><span class="s">&quot;ev2&quot;</span><span class="o">,</span> <span class="s">&quot;add to cart&quot;</span><span class="o">,</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Kafka Stream DSL</h2>

<p>Now we are ready to implement above use case with recommended Kafka Streams DSL.
The code could be optimized but I would like to present the canonical way of using DSL
without exploring DSL internals.
All examples are implemented using the latest Kafka Streams 1.0.0 version.</p>

<p>Create two input streams for page views and events
connected to &ldquo;clickstream.events&rdquo; and &ldquo;clickstream.page_views&rdquo; Kafka topics.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">builder</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamsBuilder</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evStream</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">stream</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Ev</span><span class="o">](</span><span class="s">&quot;clickstream.events&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">pvStream</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">stream</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Pv</span><span class="o">](</span><span class="s">&quot;clickstream.page_views&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Repartition topics by client and page view identifiers <code>PvKey</code>
as a prerequisite to join events with page view.
Method <code>selectKey</code> sets a new key for every input record,
and marks derived stream for repartitioning.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">PvKey</span><span class="o">(</span><span class="n">clientId</span><span class="k">:</span> <span class="kt">ClientId</span><span class="o">,</span> <span class="n">pvId</span><span class="k">:</span> <span class="kt">PvId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evToPvKeyMapper</span><span class="k">:</span> <span class="kt">KeyValueMapper</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Ev</span>, <span class="kt">PvKey</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">clientKey</span><span class="o">,</span> <span class="n">ev</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">PvKey</span><span class="o">(</span><span class="n">clientKey</span><span class="o">.</span><span class="n">clientId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">pvId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evByPvKeyStream</span> <span class="k">=</span> <span class="n">evStream</span><span class="o">.</span><span class="n">selectKey</span><span class="o">(</span><span class="n">evToPvKeyMapper</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">pvToPvKeyMapper</span><span class="k">:</span> <span class="kt">KeyValueMapper</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Pv</span>, <span class="kt">PvKey</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">clientKey</span><span class="o">,</span> <span class="n">pv</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">PvKey</span><span class="o">(</span><span class="n">clientKey</span><span class="o">.</span><span class="n">clientId</span><span class="o">,</span> <span class="n">pv</span><span class="o">.</span><span class="n">pvId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">pvByPvKeyStream</span> <span class="k">=</span> <span class="n">pvStream</span><span class="o">.</span><span class="n">selectKey</span><span class="o">(</span><span class="n">pvToPvKeyMapper</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Join event with page view streams by selected previously <code>PvKey</code>,
left join is used because we are interested also in events without matched page view.
Every incoming event is enriched by matched page view into <code>EvPv</code> structure.</p>

<p>The join window duration is set to reasonable 10 minutes.
It means, that Kafka Streams will look for messages in &ldquo;event&rdquo; and &ldquo;page view&rdquo; sides of the join
10 minutes in the past and 10 minutes in the future (using event time, not wall-clock time).
Because we are not interested in late events out of defined window,
the retention is 2 times longer than window, to hold events from the past and the future.
If you are interested why 1 milliseconds needs to be added to the retention,
please ask Kafka Streams authors not me ;)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">evPvJoiner</span><span class="k">:</span> <span class="kt">ValueJoiner</span><span class="o">[</span><span class="kt">Ev</span>, <span class="kt">Pv</span>, <span class="kt">EvPv</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span> <span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="n">pv</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">pv</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">EvPv</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="n">evId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">value</span><span class="o">,</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">EvPv</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="n">evId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">value</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="n">pv</span><span class="o">.</span><span class="n">pvId</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">pv</span><span class="o">.</span><span class="n">value</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">joinWindowDuration</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">minutes</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">joinRetention</span> <span class="k">=</span> <span class="n">joinWindowDuration</span><span class="o">.</span><span class="n">toMillis</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'><span class="k">val</span> <span class="n">joinWindow</span> <span class="k">=</span> <span class="nc">JoinWindows</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">joinWindowDuration</span><span class="o">.</span><span class="n">toMillis</span><span class="o">).</span><span class="n">until</span><span class="o">(</span><span class="n">joinRetention</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evPvStream</span> <span class="k">=</span> <span class="n">evByPvKeyStream</span><span class="o">.</span><span class="n">leftJoin</span><span class="o">(</span><span class="n">pvByPvKeyStream</span><span class="o">,</span> <span class="n">evPvJoiner</span><span class="o">,</span> <span class="n">joinWindow</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now it&rsquo;s time to fight with duplicated enriched events.
Duplicates come from unreliable nature of the network between client browser and our system.
Most real-time processing pipelines in advertising and recommendation systems are counting events,
so duplicates in the enriched clickstream could cause inaccuracies.</p>

<p>The most straightforward deduplication method is to compare incoming event with state of previously processed events.
If the event has been already processed it should be skipped.</p>

<p>Unfortunately DSL does not provide &ldquo;deduplicate&rdquo; method out-of-the-box but similar logic might be implemented with
&ldquo;reduce&rdquo; operation.</p>

<p>First we need to define deduplication window.
Deduplication window can be much shorter than join window,
we do not expect duplicates more than 10 seconds between each other.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">deduplicationWindowDuration</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">deduplicationRetention</span> <span class="k">=</span> <span class="n">deduplicationWindowDuration</span><span class="o">.</span><span class="n">toMillis</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'><span class="k">val</span> <span class="n">deduplicationWindow</span> <span class="k">=</span> <span class="nc">TimeWindows</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">deduplicationWindowDuration</span><span class="o">.</span><span class="n">toMillis</span><span class="o">).</span><span class="n">until</span><span class="o">(</span><span class="n">deduplicationRetention</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Joined stream needs to be repartitioned again by compound key <code>EvPvKey</code> composed of
client, page view and event identifiers.
This key will be used to decide if <code>EvPv</code> is a duplicate or not.
Next, the stream is grouped by selected key into KGroupedStream and
deduplicated with reduce function, where first observed event wins.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">EvPvKey</span><span class="o">(</span><span class="n">clientId</span><span class="k">:</span> <span class="kt">ClientId</span><span class="o">,</span> <span class="n">pvId</span><span class="k">:</span> <span class="kt">PvId</span><span class="o">,</span> <span class="n">evId</span><span class="k">:</span> <span class="kt">EvId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evPvToEvPvKeyMapper</span><span class="k">:</span> <span class="kt">KeyValueMapper</span><span class="o">[</span><span class="kt">PvKey</span>, <span class="kt">EvPv</span>, <span class="kt">EvPvKey</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">pvKey</span><span class="o">,</span> <span class="n">evPv</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">EvPvKey</span><span class="o">(</span><span class="n">pvKey</span><span class="o">.</span><span class="n">clientId</span><span class="o">,</span> <span class="n">pvKey</span><span class="o">.</span><span class="n">pvId</span><span class="o">,</span> <span class="n">evPv</span><span class="o">.</span><span class="n">evId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evPvByEvPvKeyStream</span> <span class="k">=</span> <span class="n">evPvStream</span><span class="o">.</span><span class="n">selectKey</span><span class="o">(</span><span class="n">evPvToEvPvKeyMapper</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evPvDeduplicator</span><span class="k">:</span> <span class="kt">Reducer</span><span class="o">[</span><span class="kt">EvPv</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">evPv1</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">evPv1</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">deduplicatedStream</span> <span class="k">=</span> <span class="n">evPvByEvPvKeyStream</span>
</span><span class='line'>  <span class="o">.</span><span class="n">groupByKey</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">reduce</span><span class="o">(</span><span class="n">evPvDeduplicator</span><span class="o">,</span> <span class="n">deduplicationWindow</span><span class="o">,</span> <span class="s">&quot;evpv-store&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">toStream</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>This deduplication implementation is debatable, due to &ldquo;continue stream&rdquo; semantics of KTable/KStream.
Reduce operation creates KTable, and this KTable is transformed again into KStream of continuous updates of the same key.
It could lead to duplicates again if the update frequency is higher than inverse of deduplication window period.
For 10 seconds deduplication window the updates should not be emitted more often than every 10 seconds but
lower updates frequency leads to higher latency.
The updates frequency is controlled globally using &ldquo;cache.max.bytes.buffering&rdquo; and &ldquo;commit.interval.ms&rdquo;
Kafka Streams properties.
See reference documentation for details:
<a href="https://docs.confluent.io/current/streams/developer-guide.html#streams-developer-guide-memory-management">Record caches in the DSL</a>.</p>

<p>I did not find another way to deduplicate events with DSL, please let me know if better implementation exists.</p>

<p>In the last stage the stream needs to be repartitioned again by client id
and published to &ldquo;clickstream.events_enriched&rdquo; Kafka topic for downstream subscribers.
In the same step mapper gets rid of the windowed key produced by windowed reduce function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">evPvToClientKeyMapper</span><span class="k">:</span> <span class="kt">KeyValueMapper</span><span class="o">[</span><span class="kt">Windowed</span><span class="o">[</span><span class="kt">EvPvKey</span><span class="o">]</span>, <span class="kt">EvPv</span>, <span class="kt">ClientId</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">windowedEvPvKey</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">windowedEvPvKey</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">clientId</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">finalStream</span> <span class="k">=</span> <span class="n">deduplicatedStream</span><span class="o">.</span><span class="n">selectKey</span><span class="o">(</span><span class="n">evPvToClientKeyMapper</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">finalStream</span><span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="s">&quot;clickstream.events_enriched&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Under The Hood</h2>

<p>Kafka Stream DSL is quite descriptive, isn&rsquo;t it?
Especially developers with strong functional programming skills appreciate the overall design.
But you will shortly see how much unexpected traffic to Kafka cluster is generated during runtime.</p>

<p>I like numbers so let&rsquo;s estimate the traffic,
based on real clickstream ingestion platform I develop on daily basis:</p>

<ul>
<li>1 kB &ndash; average page view size</li>
<li>600 B &ndash; average event size</li>
<li>4k &ndash; page views / second</li>
<li>20k &ndash; events / second</li>
</ul>


<p>It gives 24k msgs/s and 16MB/s traffic-in total, the traffic easily handled even by small Kafka cluster.</p>

<p>When stream of data is repartitioned Kafka Streams creates additional intermediate topic
and publishes on the topic whole traffic partitioned by selected key.
To be more precise it happens twice in our case, for repartitioned page views and events before join.
We need to add 24k msgs/s and 16MB/s more traffic-in to the calculation.</p>

<p>When streams of data are joined using window, Kafka Streams sends both sides of the join
to two intermediate topics again. Even if you don&rsquo;t need fault tolerance,
logging into Kafka cannot be disabled using DSL.
You cannot also get rid of window for &ldquo;this&rdquo; side of the join (window for events), more about it later on.
Add 24k msgs/s and 16MB/s more traffic-in to the calculation again.</p>

<p>To deduplicate events, joined stream goes again into Kafka Streams intermediate topic.
Add 20k msgs/s and (1kB + 1.6kB) * 20k = 52MB/s more traffic-in to the calculation again.</p>

<p>The last repartitioning by client identifier adds 20k msgs/s and 52MB/s more traffic-in.</p>

<p>Finally, instead of <strong>24k</strong> msgs/s and <strong>16MB/s</strong> traffic-in we have got
<strong>112k</strong> msgs/s and <strong>152MB</strong> traffic-in.
And I did not even count traffic from internal topics replication and standby replicas
<a href="https://docs.confluent.io/current/streams/developer-guide.html#recommended-configuration-parameters-for-resiliency">recommended for resiliency</a>.</p>

<p>Be aware that this is calculation for simple join of events and pages views generated by
local e-commerce platform in central Europe country (~20M clients).
I could also easily imagine much more complex stream topology, with tens of repartitions, joins and aggregations.</p>

<p>If you are not careful, your Kafka Streams application could easily kill your Kafka cluster.
At least our application did it once. Application deployed on 10 <a href="http://mesos.apache.org/">Mesos</a>
nodes (4CPU, 4GB RAM) almost killed Kafka cluster deployed also on 10 physical machines (32CPU, 64GB RAM, SSD).
Application was started after some time of inactivity and processed 3 hours of retention in 5 minutes
(yep, it&rsquo;s a well known vulnerability until
<a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-13+-+Quotas">KIP-13</a> is open).</p>

<h2>Kafka Processor API</h2>

<p>Now it&rsquo;s time to check Processor API and figure out how to optimize our stream topology.</p>

<p>Create the sources from input topics &ldquo;clickstream.events&rdquo; and &ldquo;clickstream.page_views&rdquo;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">new</span> <span class="nc">Topology</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSource</span><span class="o">(</span><span class="s">&quot;ev-source&quot;</span><span class="o">,</span> <span class="s">&quot;clickstream.events&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSource</span><span class="o">(</span><span class="s">&quot;pv-source&quot;</span><span class="o">,</span> <span class="s">&quot;clickstream.page_views&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because we need to join an incoming event with the collected page view in the past,
create processor which stores page view in windowed store.
The processor puts observed page views into window store for joining in the next processor.
The processed page views do not even need to be forwarded to downstream.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">PvWindowProcessor</span><span class="o">(</span><span class="k">val</span> <span class="n">pvStoreName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractProcessor</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Pv</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">pvStore</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">context</span><span class="o">().</span><span class="n">getStateStore</span><span class="o">(</span><span class="n">pvStoreName</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">WindowStore</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Pv</span><span class="o">]]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">ClientKey</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Pv</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">pvStore</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Store for page views is configured with the same size of window and retention.
This store is configured to keep duplicates due to the fact
that the key is a client id not page view id (retainDuplicates parameter).
Because join window is typically quite long (minutes) the store should be fault tolerant (logging enabled).
Even if one of the stream instances fails,
another one will continue processing with persistent window state built by failed node, cool!
Finally, the internal kafka topic can be easily configured using loggingConfig map
(replication factor, number of partitions, etc.).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pvStoreWindowDuration</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">minutes</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">retention</span> <span class="k">=</span> <span class="n">pvStoreWindowDuration</span><span class="o">.</span><span class="n">toMillis</span>
</span><span class='line'><span class="k">val</span> <span class="n">window</span> <span class="k">=</span> <span class="n">pvStoreWindowDuration</span><span class="o">.</span><span class="n">toMillis</span>
</span><span class='line'><span class="k">val</span> <span class="n">segments</span> <span class="k">=</span> <span class="mi">3</span>
</span><span class='line'><span class="k">val</span> <span class="n">retainDuplicates</span> <span class="k">=</span> <span class="kc">true</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">loggingConfig</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">pvWindowStore</span> <span class="k">=</span> <span class="nc">Stores</span><span class="o">.</span><span class="n">windowStoreBuilder</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Stores</span><span class="o">.</span><span class="n">persistentWindowStore</span><span class="o">(</span><span class="s">&quot;pv-window-store&quot;</span><span class="o">,</span> <span class="n">retention</span><span class="o">,</span> <span class="n">segments</span><span class="o">,</span> <span class="n">window</span><span class="o">,</span> <span class="n">retainDuplicates</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">ClientKeySerde</span><span class="o">,</span>
</span><span class='line'>  <span class="nc">PvSerde</span>
</span><span class='line'><span class="o">).</span><span class="n">withLoggingEnabled</span><span class="o">(</span><span class="n">loggingConfig</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first optimization you could observe is that in our scenario only one window store is created &ndash; for page views.
The window store for events is not needed, if page view is collected by system after event it does not trigger new join.</p>

<p>Add page view processor to the topology and connect with page view source upstream.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pvWindowProcessor</span><span class="k">:</span> <span class="kt">ProcessorSupplier</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Pv</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">PvWindowProcessor</span><span class="o">(</span><span class="s">&quot;pv-window-store&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">new</span> <span class="nc">Topology</span><span class="o">()</span>
</span><span class='line'>  <span class="o">(...)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addProcessor</span><span class="o">(</span><span class="s">&quot;pv-window-processor&quot;</span><span class="o">,</span> <span class="n">pvWindowProcessor</span><span class="o">,</span> <span class="s">&quot;pv-source&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, it&rsquo;s time for event and page view join processor, heart of the topology.
It seems to be complex but this processor also deduplicates joined stream using <code>evPvStore</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">EvJoinProcessor</span><span class="o">(</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">pvStoreName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">evPvStoreName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">joinWindow</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">deduplicationWindow</span><span class="k">:</span> <span class="kt">FiniteDuration</span>
</span><span class='line'><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractProcessor</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Ev</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">import</span> <span class="nn">scala.collection.JavaConverters._</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">pvStore</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">context</span><span class="o">().</span><span class="n">getStateStore</span><span class="o">(</span><span class="n">pvStoreName</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">WindowStore</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Pv</span><span class="o">]]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">evPvStore</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">context</span><span class="o">().</span><span class="n">getStateStore</span><span class="o">(</span><span class="n">evPvStoreName</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">WindowStore</span><span class="o">[</span><span class="kt">EvPvKey</span>, <span class="kt">EvPv</span><span class="o">]]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">ClientKey</span><span class="o">,</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Ev</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">timestamp</span> <span class="k">=</span> <span class="n">context</span><span class="o">().</span><span class="n">timestamp</span><span class="o">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">evPvKey</span> <span class="k">=</span> <span class="nc">EvPvKey</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="n">clientId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">pvId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">evId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">isNotDuplicate</span><span class="o">(</span><span class="n">evPvKey</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">deduplicationWindow</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">evPv</span> <span class="k">=</span> <span class="n">storedPvs</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">joinWindow</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">find</span> <span class="o">{</span> <span class="n">pv</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">pv</span><span class="o">.</span><span class="n">pvId</span> <span class="o">==</span> <span class="n">ev</span><span class="o">.</span><span class="n">pvId</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">pv</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="nc">EvPv</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="n">evId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">value</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="n">pv</span><span class="o">.</span><span class="n">pvId</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">pv</span><span class="o">.</span><span class="n">value</span><span class="o">))</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="o">.</span><span class="n">getOrElse</span> <span class="o">{</span>
</span><span class='line'>          <span class="nc">EvPv</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="n">evId</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">value</span><span class="o">,</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">context</span><span class="o">().</span><span class="n">forward</span><span class="o">(</span><span class="n">evPvKey</span><span class="o">,</span> <span class="n">evPv</span><span class="o">)</span>
</span><span class='line'>      <span class="n">evPvStore</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="n">evPvKey</span><span class="o">,</span> <span class="n">evPv</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">def</span> <span class="n">isNotDuplicate</span><span class="o">(</span><span class="n">evPvKey</span><span class="k">:</span> <span class="kt">EvPvKey</span><span class="o">,</span> <span class="n">timestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">deduplicationWindow</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">evPvStore</span><span class="o">.</span><span class="n">fetch</span><span class="o">(</span><span class="n">evPvKey</span><span class="o">,</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="n">deduplicationWindow</span><span class="o">.</span><span class="n">toMillis</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">).</span><span class="n">asScala</span><span class="o">.</span><span class="n">isEmpty</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">def</span> <span class="n">storedPvs</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">ClientKey</span><span class="o">,</span> <span class="n">timestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">joinWindow</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">pvStore</span><span class="o">.</span><span class="n">fetch</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="n">joinWindow</span><span class="o">.</span><span class="n">toMillis</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">).</span><span class="n">asScala</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>First processor performs a lookup for previously joined <code>PvEv</code> by <code>PvEvKey</code>.
If <code>PvEv</code> is found the processing is skipped because <code>EvPv</code> has been already processed.</p>

<p>Next, try to match page view to event using simple filter <code>pv.pvId == ev.pvId</code>.
We don&rsquo;t need any repartitioning to do that, only get all page views from given client
and join with event in the processor itself.
It should be very efficient because every client generates up do hundred page views in 10 minutes.
If there is no matched page view in the configured window,
<code>EvPv</code> without page view details is forwarded to the downstream.</p>

<p>Perceptive reader noticed that processor also changes the key from <code>ClientId</code> to <code>EvPvKey</code>
for deduplication purposes.
Everything is still within given client context without the need for any repartitioning.
This is possible due to the fact, that new key is more detailed than the original one.</p>

<p>As before, windowed store for deduplication needs to be configured.
Because deduplication is done in a very short window (10 seconds or so),
the logging to backed internal Kafka topic is disabled at all.
If one of the stream instance fails, we could get some duplicates during this short window, not a big deal.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">evPvStoreWindowDuration</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">retention</span> <span class="k">=</span> <span class="n">evPvStoreWindowDuration</span><span class="o">.</span><span class="n">toMillis</span>
</span><span class='line'><span class="k">val</span> <span class="n">window</span> <span class="k">=</span> <span class="n">evPvStoreWindowDuration</span><span class="o">.</span><span class="n">toMillis</span>
</span><span class='line'><span class="k">val</span> <span class="n">segments</span> <span class="k">=</span> <span class="mi">3</span>
</span><span class='line'><span class="k">val</span> <span class="n">retainDuplicates</span> <span class="k">=</span> <span class="kc">false</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">evPvStore</span> <span class="k">=</span> <span class="nc">Stores</span><span class="o">.</span><span class="n">windowStoreBuilder</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Stores</span><span class="o">.</span><span class="n">persistentWindowStore</span><span class="o">(</span><span class="s">&quot;ev-pv-window-store&quot;</span><span class="o">,</span> <span class="n">retention</span><span class="o">,</span> <span class="n">segments</span><span class="o">,</span> <span class="n">window</span><span class="o">,</span> <span class="n">retainDuplicates</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">EvPvKeySerde</span><span class="o">,</span>
</span><span class='line'>  <span class="nc">EvPvSerde</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add join processor to the topology and connect with event source upstream.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">evJoinProcessor</span><span class="k">:</span> <span class="kt">ProcessorSupplier</span><span class="o">[</span><span class="kt">ClientKey</span>, <span class="kt">Ev</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">EvJoinProcessor</span><span class="o">(</span><span class="s">&quot;pv-window-store&quot;</span><span class="o">,</span> <span class="s">&quot;ev-pv-window-store&quot;</span><span class="o">,</span> <span class="n">pvStoreWindowDuration</span><span class="o">,</span> <span class="n">evPvStoreWindowDuration</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">new</span> <span class="nc">Topology</span><span class="o">()</span>
</span><span class='line'>  <span class="o">(...)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addProcessor</span><span class="o">(</span><span class="s">&quot;ev-join-processor&quot;</span><span class="o">,</span> <span class="n">evJoinProcessor</span><span class="o">,</span> <span class="s">&quot;ev-source&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last processor maps compound key <code>EvPvKey</code> again into <code>ClientId</code>.
Because client identifier is already a part of the compound key,
mapping is done by the processor without the need for further repartitioning.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">EvPvMapProcessor</span> <span class="k">extends</span> <span class="nc">AbstractProcessor</span><span class="o">[</span><span class="kt">EvPvKey</span>, <span class="kt">EvPv</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">EvPvKey</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">EvPv</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">context</span><span class="o">().</span><span class="n">forward</span><span class="o">(</span><span class="nc">ClientKey</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="n">clientId</span><span class="o">),</span> <span class="n">value</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the map processor to the topology.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">evPvMapProcessor</span><span class="k">:</span> <span class="kt">ProcessorSupplier</span><span class="o">[</span><span class="kt">EvPvKey</span>, <span class="kt">EvPv</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">EvPvMapProcessor</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">new</span> <span class="nc">Topology</span><span class="o">()</span>
</span><span class='line'>  <span class="o">(...)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addProcessor</span><span class="o">(</span><span class="s">&quot;ev-pv-map-processor&quot;</span><span class="o">,</span> <span class="n">evPvMapProcessor</span><span class="o">,</span> <span class="s">&quot;ev-pv-join-processor&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally publish join results to &ldquo;clickstream.events_enriched&rdquo; Kafka topic.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">new</span> <span class="nc">Topology</span><span class="o">()</span>
</span><span class='line'>  <span class="o">(...)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSink</span><span class="o">(</span><span class="s">&quot;ev-pv-sink&quot;</span><span class="o">,</span> <span class="nc">EvPvTopic</span><span class="o">,</span> <span class="s">&quot;clickstream.events_enriched&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a processor requires access to the store this fact must be registered.
It would be nice to have statically typed Topology API for registration,
but now if the store is not connected to the processor,
or is connected to the wrong store,
runtime exception is thrown during application startup.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">new</span> <span class="nc">Topology</span><span class="o">()</span>
</span><span class='line'>  <span class="o">(...)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addStateStore</span><span class="o">(</span><span class="n">pvStore</span><span class="o">,</span> <span class="s">&quot;pv-window-processor&quot;</span><span class="o">,</span> <span class="s">&quot;ev-join-processor&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addStateStore</span><span class="o">(</span><span class="n">evPvStore</span><span class="o">,</span> <span class="s">&quot;ev-join-processor&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s count Kafka Streams internal topics overhead for Processor API version.
Wait, there is only one internal topic, for page view join window!
It gives 4k messages per second and 4MB traffic-in overhead, not more.</p>

<p><strong>28k</strong> instead of <strong>112k</strong> messages per second and <strong>20MB</strong> instead of <strong>152MB</strong> traffic-in in total.
It is a noticeable difference between Processor API and DSL topology versions,
especially if we keep in mind that enrichment results are almost identical to results from DSL version.</p>

<h2>Summary</h2>

<p>Dear readers, are you still with me after long lecture with not so easy to digest Scala code?
I hope so :)</p>

<p>My final thoughts about Kafka Streams:</p>

<ul>
<li>Kafka DSL looks great at first, functional and declarative API sells the product, no doubts.</li>
<li>Unfortunately Kafka DSL hides a lot of internals which should be exposed via the API
(stores configuration, join semantics, repartitioning) &ndash; see
<a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-182%3A+Reduce+Streams+DSL+overloads+and+allow+easier+use+of+custom+storage+engines">KIP-182</a>.</li>
<li>Processor API seems to be more complex and less sexy than DSL.</li>
<li>But Processor API allows you to create hand-crafted, very efficient stream topologies.</li>
<li>I did not present any Kafka Streams test (what&rsquo;s the shame &ndash; I&rsquo;m sorry)
but I think testing would be easier with Processor API than DSL.
With DSL it has to be an integration test, processors can be easily unit tested in separation with a few mocks.</li>
<li>As Scala developer I prefer Processor API than DSL,
e.g. Scala compiler could not infer KStream generic types.</li>
<li>It&rsquo;s a pleasure to work with processor and fluent Topology APIs.</li>
<li>I&rsquo;m really keen on KSQL future, it would be great to get optimized engine like
<a href="https://databricks.com/blog/2015/04/13/deep-dive-into-spark-sqls-catalyst-optimizer.html">Spark Catalyst</a> eventually.</li>
<li>Finally, Kafka Streams library is extraordinarily fast and hardware efficient, if you know what you are doing.</li>
</ul>


<p>As always working code is published on
<a href="https://github.com/mkuthan/example-kafkastreams">https://github.com/mkuthan/example-kafkastreams</a>.
The project is configured with <a href="https://github.com/manub/scalatest-embedded-kafka">Embedded Kafka</a>
and does not require any additional setup.
Just uncomment either DSL or Processor API version, run main class and observe enriched stream of events on the console.</p>

<p>Enjoy!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Marcin Kuthan</span></span>

      








  


<time datetime="2017-11-02T00:00:00+00:00" pubdate data-updated="true">Nov 2<span>nd</span>, 2017</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/kafka/'>kafka</a>, <a class='category' href='/blog/categories/kafka-streams/'>kafka streams</a>, <a class='category' href='/blog/categories/scala/'>scala</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mkuthan.github.io/blog/2017/11/02/kafka-streams-dsl-vs-processor-api/" data-via="MarcinKuthan" data-counturl="http://mkuthan.github.io/blog/2017/11/02/kafka-streams-dsl-vs-processor-api/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/11/18/apache-bigdata-europe/" title="Previous Post: Apache BigData Europe Conference Summary">&laquo; Apache BigData Europe Conference Summary</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/11/02/kafka-streams-dsl-vs-processor-api/">Kafka Streams DSL vs Processor API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/18/apache-bigdata-europe/">Apache BigData Europe Conference Summary</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/30/spark-streaming-on-yarn/">Long-running Spark Streaming Jobs on YARN Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/11/spark-application-assembly/">Spark Application Assembly for Cluster Deployments</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/29/spark-kafka-integration2/">Spark and Kafka Integration Patterns, Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/06/spark-kafka-integration1/">Spark and Kafka Integration Patterns, Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/01/spark-unit-testing/">Spark and Spark Streaming Unit Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/ddd-how-to-learn/">How to Learn DDD</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/15/programming_language_does_not_matter/">Programming Language Does Not Matter</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/20/mastering-nodejs-book-review/">Mastering Node.js - Book Review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/26/soa-patterns-book-review/">SOA Patterns - Book Review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/21/release-it-book-review/">Rrelease It! - Book Review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/29/acceptance-testing-using-jbehave-spring-framework-and-maven/">Acceptance Testing Using JBehave, Spring Framework and Maven</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/27/the-twelve-factor-app-part2/">The Twelve-Factor App - Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/26/the-twelve-factor-app-part1/">The Twelve-Factor App - Part 1</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Category Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/architecture' style='font-size: 148.0%'>architecture(4)</a> <a href='/blog/categories/artifactory' style='font-size: 112.0%'>artifactory(1)</a> <a href='/blog/categories/bash' style='font-size: 112.0%'>bash(1)</a> <a href='/blog/categories/books' style='font-size: 136.0%'>books(3)</a> <a href='/blog/categories/conferences' style='font-size: 112.0%'>conferences(1)</a> <a href='/blog/categories/craftsmanship' style='font-size: 136.0%'>craftsmanship(3)</a> <a href='/blog/categories/ddd' style='font-size: 124.0%'>DDD(2)</a> <a href='/blog/categories/dvcs' style='font-size: 112.0%'>DVCS(1)</a> <a href='/blog/categories/git' style='font-size: 124.0%'>git(2)</a> <a href='/blog/categories/hdfs' style='font-size: 112.0%'>hdfs(1)</a> <a href='/blog/categories/java' style='font-size: 124.0%'>java(2)</a> <a href='/blog/categories/jbehave' style='font-size: 112.0%'>jbehave(1)</a> <a href='/blog/categories/jee' style='font-size: 112.0%'>JEE(1)</a> <a href='/blog/categories/jira' style='font-size: 112.0%'>jira(1)</a> <a href='/blog/categories/jms' style='font-size: 112.0%'>JMS(1)</a> <a href='/blog/categories/jvm' style='font-size: 112.0%'>jvm(1)</a> <a href='/blog/categories/kafka' style='font-size: 148.0%'>kafka(4)</a> <a href='/blog/categories/kafka-streams' style='font-size: 112.0%'>kafka streams(1)</a> <a href='/blog/categories/linux' style='font-size: 136.0%'>linux(3)</a> <a href='/blog/categories/maven' style='font-size: 124.0%'>maven(2)</a> <a href='/blog/categories/node-js' style='font-size: 112.0%'>node.js(1)</a> <a href='/blog/categories/performance' style='font-size: 112.0%'>performance(1)</a> <a href='/blog/categories/php' style='font-size: 112.0%'>PHP(1)</a> <a href='/blog/categories/presentations' style='font-size: 112.0%'>presentations(1)</a> <a href='/blog/categories/python' style='font-size: 112.0%'>python(1)</a> <a href='/blog/categories/ruby' style='font-size: 112.0%'>ruby(1)</a> <a href='/blog/categories/sbt' style='font-size: 112.0%'>sbt(1)</a> <a href='/blog/categories/scala' style='font-size: 160.0%'>scala(5)</a> <a href='/blog/categories/smtp' style='font-size: 112.0%'>smtp(1)</a> <a href='/blog/categories/spark' style='font-size: 160.0%'>spark(5)</a> <a href='/blog/categories/spring' style='font-size: 148.0%'>spring(4)</a> <a href='/blog/categories/tdd' style='font-size: 112.0%'>TDD(1)</a> <a href='/blog/categories/virtual-box' style='font-size: 112.0%'>virtual box(1)</a> <a href='/blog/categories/yarn' style='font-size: 112.0%'>yarn(1)</a> </span>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mkuthan">@mkuthan</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mkuthan',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>About Me</h1>
  <p>Marcin Kuthan, genuine software engineer at <a href="http://allegrogroup.com/">Allegro Group</a>.</p>
</section>

<section>
	<span>
		<img src="http://www.gravatar.com/avatar/71e9ba5350f53c3416b7ed2617d04ab5" alt="Gravatar of Marcin Kuthan " title="Gravatar of Marcin Kuthan" />
	</span>
</section>
<section>
  <h1>Links</h1>
  <p><a href="http://allegro.tech/"><img src="http://allegro.tech/img/logo-allegro-tech.svg" alt="allegro.tech"></a></p>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Marcin Kuthan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mkuthan';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mkuthan.github.io/blog/2017/11/02/kafka-streams-dsl-vs-processor-api/';
        var disqus_url = 'http://mkuthan.github.io/blog/2017/11/02/kafka-streams-dsl-vs-processor-api/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
